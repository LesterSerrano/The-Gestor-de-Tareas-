@model IEnumerable<GestordeTaras.EN.Proyecto>

@{
    ViewData["Title"] = "Index";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

﻿
<h1 class="text-5xl mb-8 mt-4 font-extrabold dark:text-white">Proyectos</h1>

<div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
    <div class="d-flex flex-grow">
        @if (User.Identity.IsAuthenticated && User.IsInRole("Administrador"))
        {
            <p>
                <button type="button"
                        class="no-underline hover:no-underline text-white bg-purple-700 hover:bg-purple-800 focus:outline-none focus:ring-4 focus:ring-purple-300 font-medium rounded-full text-lg px-5 py-2.5 text-center mb-2 dark:bg-purple-600 dark:hover:bg-purple-700 dark:focus:ring-purple-900 inline-flex items-center"
                        onclick="cargarVistaCreate()">
                    <i class="fas fa-plus text-lg mr-2"></i> nuevo
                </button>
            </p>
        }
        else
        {
            <div class="invisible" style="width: 130px;"></div>
        }
    </div>

    <form method="get" asp-action="Index" class="flex items-center">
        <div class="flex items-center mr-4">
            <span class="mr-2">Buscar por:</span>
            <select name="filter" class="border border-gray-300 rounded-md p-2 w-32">
                <option value="Titulo">Título</option>
                <option value="Administrador">Administrador</option>
            </select>
        </div>
        <div class="flex items-center">
            <label for="query" class="sr-only">Ingrese el término de búsqueda:</label>
            <input type="text" name="query" class="border border-gray-300 rounded-md p-2" placeholder="Buscar..." aria-label="Ingrese el término de búsqueda" />
            <button type="submit" class="bg-purple-500 text-white font-semibold rounded-md p-2 ml-2 hover:bg-purple-600 transition duration-200">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </form>
</div>


@if (Model != null && Model.Any())
{
    <div id="tablaActualizablePosi" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @foreach (var item in Model)
        {
            <div class="relative rounded-lg border border-gray-300 p-6 bg-white dark:bg-gray-800 shadow-sm w-full mb-4">
                <!-- Botón principal flotante y menú desplegable -->
                <div class="absolute top-0 right-0 mt-1 mr-1">
                    @if (User.IsInRole("Administrador"))
                    {
                        <!-- Botón principal flotante -->
                        <button class="rounded-full bg-gray-200 w-10 h-10 flex items-center justify-center shadow-lg transition-all duration-300 transform hover:scale-110 hover:rotate-180 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" id="menuButton-@item.Id" onclick="toggleMenu(@item.Id)">
                            <i class="fas fa-ellipsis-v text-gray-800 text-xl"></i>
                        </button>

                        <!-- Menú desplegable -->
                        <div id="menu-@item.Id" class="absolute right-0 mt-2 w-36 bg-white rounded-lg py-2 shadow-md hidden z-10 transition-all duration-300 ease-out transform">
                            <div class="space-y-1 px-3">
                                <button type="button"
                                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded"
                                        onclick="cargarVistaEdit(@item.Id)">
                                    <i class="fas fa-edit text-base"></i>
                                </button>
                                <button type="button"
                                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-3 rounded"
                                        onclick="cargarVistaDelete(@item.Id)">
                                    <i class="fas fa-trash-alt text-lg"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">@item.Titulo</h2>

                <div class="flex items-center justify-center mb-4">
                    <img class="h-10 w-10 rounded-full border-2 border-gray-300 mr-3" src="@item.Usuario.FotoPerfil" alt="@item.Usuario.Nombre @item.Usuario.Apellido" />
                    <p class="text-sm text-gray-500">
                        <span class="font-semibold">Administrador:</span> @item.Usuario.Nombre @item.Usuario.Apellido
                    </p>
                </div>

                <p class="text-gray-700 dark:text-gray-400 mb-4 text-center">
                    @if (item.Descripcion.Length > 100)
                    {
                        <text>@item.Descripcion.Substring(0, 100)...</text>
                    }
                    else
                    {
                        <text>@item.Descripcion</text>
                    }
                </p>

                <p class="text-sm text-gray-500 mb-4 text-center">
                    <span class="font-semibold text-gray-500 dark:text-gray-400">Fecha de finalización:</span> @item.FechaFinalizacion.ToShortDateString()
                </p>

                <div class="flex items-center justify-center text-gray-500 mb-2">
                    <i class="fas fa-users mr-2"></i>
                    <span class="text-sm">@((item.ProyectoUsuario?.Count ?? 0)) usuarios unidos</span>
                </div>

                <div class="flex justify-center mb-4 min-h-[32px]">
                    <div class="flex -space-x-2">
                        @if (item.ProyectoUsuario != null && item.ProyectoUsuario.Any())
                        {
                            @foreach (var proyectoUsuario in item.ProyectoUsuario.Take(3))
                            {
                                <img class="h-8 w-8 rounded-full border-2 border-white"
                                     src="@proyectoUsuario.Usuario.FotoPerfil"
                                     alt="@proyectoUsuario.Usuario.Nombre" />
                            }
                            @if (item.ProyectoUsuario.Count() > 3)
                            {
                                <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600">
                                    <span class="text-xs font-medium">+@(item.ProyectoUsuario.Count() - 3)</span>
                                </div>
                            }
                        }
                        else
                        {
                            <img class="h-8 w-8 opacity-0" src="" alt="placeholder" />
                        }
                    </div>
                </div>


                <div class="flex justify-between mt-4">
                    @if (User.IsInRole("Administrador"))
                    {
                        <a href="@Url.Action("Details", "Proyecto", new { id = item.Id })"
                           class="flex items-center justify-center px-4 py-2 border border-gray-400 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 text-sm font-medium no-underline transition-all duration-200 ease-out">
                            <i class="fa-solid fa-sliders mr-4"></i> Detalles
                        </a>

                    }
                    else if (User.IsInRole("Colaborador"))
                    {
                        <a href="@Url.Action("Details", "Proyecto", new { id = item.Id })"
                           class="flex items-center justify-center px-4 py-2 border border-green-400 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-green-300 dark:hover:bg-green-700 text-sm font-medium no-underline transition-all duration-200 ease-out">
                            <i class="fas fa-user-plus mr-4"></i> Unirse
                        </a>

                    }
 
                    <a href="@Url.Action("Index", "Tarea", new { proyectoId = item.Id })"
                       class="flex items-center justify-center px-4 py-2 bg-purple-800 text-white rounded-lg hover:bg-purple-600 text-sm font-medium no-underline transition-all duration-200 ease-out">
                        <i class="fas fa-sign-in-alt mr-4"></i> Ingresar
                    </a>

                </div>

            </div>
        }
    </div>

}
else
{
    <div class="flex flex-col items-center justify-center mt-10">
        <img src="~/img/found.svg" alt="No hay proyectos disponibles" class="w-36 h-36 mb-4" />
        <h1 class="text-2xl font-bold text-gray-700">No hay proyectos disponibles</h1>
        <p class="mt-2 text-gray-500">Crea un nuevo proyecto para comenzar a trabajar.</p>
    </div>
}

<!-- Modal de Create -->
<div id="createModal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center px-6 py-4 bg-purple-700 text-white rounded-t-xl">
            <h3 class="text-xl font-semibold">Agregar Proyecto</h3>
            <button onclick="closeModal('createModal')" class="text-white text-xl font-bold">×</button>
        </div>
        <div id="createModalContent" class="px-3 py-2">
            <!-- Aquí se cargará la vista Create con AJAX -->
        </div>
        <div class="px-6 py-4 flex justify-center space-x-3">
            <button onclick="submitcreateForm('createForm')"
                    class="px-5 py-2.5 bg-purple-700 hover:bg-purple-800 text-white rounded-lg font-medium">
                Guardar
            </button>

            <button onclick="closeModal('createModal')"
                    class="px-5 py-2.5 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal Edit -->
<div id="editModal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center px-6 py-4 bg-blue-600 text-white rounded-t-xl">
            <h3 class="text-xl font-semibold">Editar Proyecto</h3>
            <button onclick="closeModal('editModal')" class="text-white text-xl font-bold">×</button>
        </div>
        <div id="editModalContent" class="px-3 py-2">
            <!-- Aquí se cargará el formulario Edit.cshtml con AJAX -->
        </div>
        <div class="px-6 py-4 flex justify-center space-x-3">
            <button onclick="submiteditForm('editForm')"
                    class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                Guardar cambios
            </button>
            <button onclick="closeModal('editModal')"
                    class="px-5 py-2.5 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal Delete -->
<div id="deleteModal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg">
        <div class="flex justify-between items-center px-6 py-4 bg-red-600 text-white rounded-t-xl">
            <h3 class="text-xl font-semibold">Eliminar Proyecto</h3>
            <button onclick="closeModal('deleteModal')" class="text-white text-xl font-bold">×</button>
        </div>
        <div id="deleteModalContent" class="px-3 py-2">
            <!-- Aquí se cargará la vista Delete -->
        </div>
        <div class="px-6 py-4 flex justify-center space-x-3">
            <button onclick="eliminarProyecto()"
                    class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">
                Eliminar
            </button>
            <button onclick="closeModal('deleteModal')"
                    class="px-5 py-2.5 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                Cancelar
            </button>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="~/js/Proyecto.js"></script>

